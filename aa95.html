<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Audio Control Panel Simulator</title>

<!-- PWA Meta Tags -->
<meta name="description" content="Aircraft Audio Control Panel Simulator">
<meta name="theme-color" content="#1a1a1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="AA95">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16.png">

<style>
:root{ --w:940px; --h:314px; }

* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  min-height: 100%;
  background: #222;
  font-family: Arial, sans-serif;
}

body {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
  padding: max(20px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left));
  gap: 20px;
}

/* Back link */
.back-link {
  width: 100%;
  max-width: var(--w);
}

.back-link a {
  color: #7fffb9;
  text-decoration: none;
  font-size: 14px;
  opacity: 0.8;
  transition: opacity 0.2s;
}

.back-link a:hover { opacity: 1; }

/* Panel wrapper — scales to viewport */
.panel-wrap {
  width: 100%;
  max-width: var(--w);
}

.panel {
  width: 100%;
  aspect-ratio: 940 / 314;
  position: relative;
  user-select: none;
  touch-action: none;
}

svg { width: 100%; height: 100%; }

/* invisible hotspots */
.hotspot { fill: rgba(0,0,0,0); cursor: pointer; }

/* ===== REALISTIC LEVER ===== */
.lever {
  pointer-events: none;
  transform-origin: center 20%;
  transition:
    transform 120ms cubic-bezier(.2,.8,.4,1),
    filter 120ms linear;
  filter: drop-shadow(0 2px 2px rgba(0,0,0,.35));
}

.lever.on {
  transform:
    translateY(10px)
    rotateX(18deg);
  filter: drop-shadow(0 1px 1px rgba(0,0,0,.6));
}

.lever.press {
  transform: translateY(4px);
}

.lever rect:first-child {
  fill: url(#leverGrad);
}

/* selector debug needle */
.needle { opacity: 0; }
.debug .needle { opacity: 1; }

/* ===== STATUS DISPLAY ===== */
.status {
  background: #0a1a10;
  border: 1px solid #041;
  border-radius: 4px;
  padding: 12px 16px;
  width: 100%;
  max-width: var(--w);
  font-family: 'Courier New', monospace;
  color: #7fffb9;
  font-size: 11px;
}

.status h3 {
  margin: 0 0 8px 0;
  font-size: 12px;
  border-bottom: 1px solid #143;
  padding-bottom: 6px;
}

.status-row {
  display: flex;
  justify-content: space-between;
  padding: 2px 0;
}

.status-label { color: #5fdf99; }
.status-value { color: #fff; }

/* ===== GUIDE ===== */
.guide {
  background: #151515;
  border: 1px solid #333;
  border-radius: 6px;
  padding: 16px 20px;
  width: 100%;
  max-width: var(--w);
  color: #aaa;
  font-size: 12px;
}

.guide h2 {
  color: #7fffb9;
  font-size: 14px;
  margin: 0 0 10px 0;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.guide p {
  margin: 0 0 6px 0;
  line-height: 1.4;
}

.guide .key {
  color: #7fffb9;
  font-weight: bold;
}
</style>
</head>
<body>

<div class="back-link">
  <a href="/">← HOME</a>
</div>

<div class="panel-wrap">
  <div class="panel" id="panel">
  <svg viewBox="0 0 940 314">

  <defs>
  <linearGradient id="leverGrad" x1="0" y1="0" x2="0" y2="1">
    <stop offset="0%"   stop-color="#ffffff"/>
    <stop offset="60%"  stop-color="#e9e9e9"/>
    <stop offset="100%" stop-color="#dcdcdc"/>
  </linearGradient>
  </defs>

  <!-- BACKGROUND -->
  <image href="control-panel.jpg" x="0" y="0" width="940" height="314"/>

  <!-- ===== LEVER OVERLAYS ===== -->

  <g id="lever-com1" class="lever">
    <rect x="147" y="18" width="26" height="62" rx="11"/>
  </g>

  <g id="lever-com2" class="lever">
    <rect x="227" y="18" width="26" height="62" rx="11"/>
  </g>

  <g id="lever-fm1" class="lever">
    <rect x="307" y="18" width="26" height="62" rx="11"/>
  </g>

  <g id="lever-fm2" class="lever">
    <rect x="387" y="18" width="26" height="62" rx="11"/>
  </g>

  <g id="lever-aux" class="lever">
    <rect x="467" y="18" width="26" height="62" rx="11"/>
  </g>

  <!-- ISO / KEY -->
  <g id="lever-iso" class="lever">
    <rect x="86" y="188" width="30" height="72" rx="13"/>
  </g>

  <g id="lever-key" class="lever">
    <rect x="753" y="188" width="30" height="72" rx="13"/>
  </g>

  <!-- selector debug needle -->
  <line id="needle" class="needle" x1="470" y1="215" x2="560" y2="215"
  stroke="white" stroke-width="3"/>

  <!-- ===== HOTSPOTS ===== -->

  <rect class="hotspot" id="com1_toggle" x="120" y="5"  width="80" height="100"/>
  <rect class="hotspot" id="com2_toggle" x="200" y="5"  width="80" height="100"/>
  <rect class="hotspot" id="fm1_toggle"  x="280" y="5"  width="80" height="100"/>
  <rect class="hotspot" id="fm2_toggle"  x="360" y="5"  width="80" height="100"/>
  <rect class="hotspot" id="aux_toggle"  x="440" y="5"  width="80" height="100"/>

  <rect class="hotspot" id="iso_emr"    x="40"  y="160" width="120" height="140"/>
  <rect class="hotspot" id="key_toggle" x="720" y="160" width="90"  height="140"/>

  <!-- selector -->
  <rect class="hotspot" id="selector_knob" x="350" y="60" width="260" height="240"/>

  </svg>
  </div>
</div>

<!-- Status Display -->
<div class="status">
  <h3>Panel Status</h3>
  <div class="status-row">
    <span class="status-label">Selector:</span>
    <span class="status-value" id="statSelector">COM1</span>
  </div>
  <div class="status-row">
    <span class="status-label">Active RX:</span>
    <span class="status-value" id="statRx">None</span>
  </div>
  <div class="status-row">
    <span class="status-label">ISO/EMR:</span>
    <span class="status-value" id="statIso">OFF</span>
  </div>
  <div class="status-row">
    <span class="status-label">KEY:</span>
    <span class="status-value" id="statKey">OFF</span>
  </div>
</div>

<!-- Guide -->
<div class="guide">
  <h2>How to Operate</h2>
  <p><span class="key">RX Toggles (top row):</span> Click COM1, COM2, FM1, FM2, or AUX to toggle receive on/off</p>
  <p><span class="key">ISO/EMR (lower left):</span> Click to toggle isolation / emergency</p>
  <p><span class="key">KEY (lower right):</span> Click to toggle keying</p>
  <p><span class="key">Selector Knob (center):</span> Click and drag to snap between COM1 → FM → AUX → PA</p>
</div>

<script>
const levers = {
  com1_toggle: "lever-com1",
  com2_toggle: "lever-com2",
  fm1_toggle:  "lever-fm1",
  fm2_toggle:  "lever-fm2",
  aux_toggle:  "lever-aux",
  iso_emr:     "lever-iso",
  key_toggle:  "lever-key"
};

const state = {};
let currentSelector = "COM1";

function emit(d) {
  window.dispatchEvent(new CustomEvent("panel:change", { detail: d }));
}

function flip(id) {
  const next = !state[id];
  state[id] = next;

  const el = document.getElementById(levers[id]);
  if (el) el.classList.toggle("on", next);

  emit({ type: "toggle", id, value: next });
  updateStatus();
}

/* tactile press */
document.querySelectorAll(".hotspot").forEach(h => {
  const id = h.id;

  if (levers[id]) {
    h.onpointerdown = () => {
      const l = document.getElementById(levers[id]);
      l.classList.add("press");
    };
    h.onpointerup = () => {
      const l = document.getElementById(levers[id]);
      l.classList.remove("press");
      flip(id);
    };
  }
});

/* ===== SELECTOR DETENTS ===== */

const detents = [
  { name: "COM1", deg: -120 },
  { name: "FM",   deg: -40  },
  { name: "AUX",  deg:  40  },
  { name: "PA",   deg:  120 }
];

const cx = 470, cy = 215;

function angle(x, y) {
  return Math.atan2(y - cy, x - cx) * 180 / Math.PI;
}

function nearest(a) {
  let best = 0, d = 999;
  detents.forEach((s, i) => {
    const diff = Math.abs(a - s.deg);
    if (diff < d) { d = diff; best = i; }
  });
  return best;
}

document.getElementById("selector_knob").onpointermove = e => {
  if (e.buttons !== 1) return;
  const r = e.target.getBoundingClientRect();
  const x = (e.clientX - r.left) * (940 / r.width);
  const y = (e.clientY - r.top)  * (314 / r.height);

  const a = angle(x, y);
  const i = nearest(a);

  const rad = detents[i].deg * Math.PI / 180;
  const x2  = cx + Math.cos(rad) * 90;
  const y2  = cy + Math.sin(rad) * 90;

  const n = document.getElementById("needle");
  n.setAttribute("x2", x2);
  n.setAttribute("y2", y2);

  currentSelector = detents[i].name;
  emit({ type: "selector", step: detents[i].name });
  updateStatus();
};

/* ===== STATUS ===== */
function updateStatus() {
  document.getElementById("statSelector").textContent = currentSelector;

  const rxMap = {
    com1_toggle: "COM1",
    com2_toggle: "COM2",
    fm1_toggle:  "FM1",
    fm2_toggle:  "FM2",
    aux_toggle:  "AUX"
  };
  const activeRx = Object.entries(rxMap)
    .filter(([id]) => state[id])
    .map(([, label]) => label)
    .join(", ");
  document.getElementById("statRx").textContent  = activeRx  || "None";
  document.getElementById("statIso").textContent = state["iso_emr"]    ? "ON" : "OFF";
  document.getElementById("statKey").textContent = state["key_toggle"] ? "ON" : "OFF";
}

updateStatus();

/* ===== SERVICE WORKER ===== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('SW registered:', reg.scope))
      .catch(err => console.log('SW registration failed:', err));
  });
}
</script>
</body>
</html>
