<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Audio Control Panel Simulator</title>

<!-- PWA Meta Tags -->
<meta name="description" content="Aircraft Audio Control Panel Simulator">
<meta name="theme-color" content="#1a1a1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="AA95">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16.png">

<style>
:root{ --w:940px; --h:314px; }

* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  min-height: 100%;
  background: #222;
  font-family: Arial, sans-serif;
}

body {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
  padding: max(20px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left));
  gap: 20px;
}

/* Back link */
.back-link {
  width: 100%;
  max-width: var(--w);
}

.back-link a {
  color: #7fffb9;
  text-decoration: none;
  font-size: 14px;
  opacity: 0.8;
  transition: opacity 0.2s;
}

.back-link a:hover { opacity: 1; }

/* Panel wrapper — scales to viewport */
.panel-wrap {
  width: 100%;
  max-width: var(--w);
}

.panel {
  width: 100%;
  aspect-ratio: 940 / 314;
  position: relative;
  user-select: none;
  touch-action: none;
}

svg { width: 100%; height: 100%; }

/* invisible hotspots */
.hotspot { fill: rgba(0,0,0,0); cursor: pointer; }



/* photo-real switch patches (DOWN state overlays) */
.switchPatch {
  pointer-events: none;
  transition: opacity 0.15s ease-out, transform 0.15s ease-out;
  transform-box: fill-box;
  transform-origin: center center;
}
/* selector debug needle */
.needle { opacity: 0; }
.debug .needle { opacity: 1; }

/* ===== STATUS DISPLAY ===== */
.status {
  background: #0a1a10;
  border: 1px solid #041;
  border-radius: 4px;
  padding: 12px 16px;
  width: 100%;
  max-width: var(--w);
  font-family: 'Courier New', monospace;
  color: #7fffb9;
  font-size: 11px;
}

.status h3 {
  margin: 0 0 8px 0;
  font-size: 12px;
  border-bottom: 1px solid #143;
  padding-bottom: 6px;
}

.status-row {
  display: flex;
  justify-content: space-between;
  padding: 2px 0;
}

.status-label { color: #5fdf99; }
.status-value { color: #fff; }

/* ===== GUIDE ===== */
.guide {
  background: #151515;
  border: 1px solid #333;
  border-radius: 6px;
  padding: 16px 20px;
  width: 100%;
  max-width: var(--w);
  color: #aaa;
  font-size: 12px;
}

.guide h2 {
  color: #7fffb9;
  font-size: 14px;
  margin: 0 0 10px 0;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.guide p {
  margin: 0 0 6px 0;
  line-height: 1.4;
}

.guide .key {
  color: #7fffb9;
  font-weight: bold;
}
</style>
</head>
<body>

<div class="back-link">
  <a href="/">← HOME</a>
</div>

<div class="panel-wrap">
  <div class="panel" id="panel">
  <svg viewBox="0 0 940 314" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<!-- BACKGROUND -->
  <image href="images/aa95/panel-bg.jpg" x="0" y="0" width="940" height="314"/>
  
      <!-- SWITCH PATCHES (photo overlays) -->
  <image id="patch_com1_toggle" class="switchPatch" href="images/aa95/com1_toggle.png" x="120" y="5" width="80" height="100" style="opacity:0;"/>
  <image id="patch_com2_toggle" class="switchPatch" href="images/aa95/com2_toggle.png" x="200" y="5" width="80" height="100" style="opacity:0;"/>
  <image id="patch_fm1_toggle" class="switchPatch" href="images/aa95/fm1_toggle.png" x="280" y="5" width="80" height="100" style="opacity:0;"/>
  <image id="patch_fm2_toggle" class="switchPatch" href="images/aa95/fm2_toggle.png" x="360" y="5" width="80" height="100" style="opacity:0;"/>
  <image id="patch_aux_toggle" class="switchPatch" href="images/aa95/aux_toggle.png" x="440" y="5" width="80" height="100" style="opacity:0;"/>
  <image id="patch_adf_toggle" class="switchPatch" href="images/aa95/adf_toggle.png" x="555" y="0" width="75" height="110" style="opacity:0;"/>
  <image id="patch_dplr_toggle" class="switchPatch" href="images/aa95/dplr_toggle.png" x="625" y="0" width="75" height="110" style="opacity:0;"/>
  <image id="patch_pat_toggle" class="switchPatch" href="images/aa95/pat_toggle.png" x="700" y="0" width="95" height="110" style="opacity:0;"/>
  <image id="patch_iso_emr" class="switchPatch" href="images/aa95/iso_emr.png" x="20" y="180" width="150" height="134" style="opacity:0;"/>
  <image id="patch_key_toggle" class="switchPatch" href="images/aa95/key_toggle.png" x="650" y="185" width="120" height="129" style="opacity:0;"/>

<!-- TOGGLE HOTSPOTS -->
  <rect class="hotspot" id="com1_toggle" x="120" y="5" width="80" height="100"/>
  <rect class="hotspot" id="com2_toggle" x="200" y="5" width="80" height="100"/>
  <rect class="hotspot" id="fm1_toggle" x="280" y="5" width="80" height="100"/>
  <rect class="hotspot" id="fm2_toggle" x="360" y="5" width="80" height="100"/>
  <rect class="hotspot" id="aux_toggle" x="440" y="5" width="80" height="100"/>
  <rect class="hotspot" id="adf_toggle" x="555" y="0" width="75" height="110"/>
  <rect class="hotspot" id="dplr_toggle" x="625" y="0" width="75" height="110"/>
  <rect class="hotspot" id="pat_toggle" x="700" y="0" width="95" height="110"/>
  <rect class="hotspot" id="iso_emr" x="20" y="180" width="150" height="134"/>
  <rect class="hotspot" id="key_toggle" x="650" y="185" width="120" height="129"/>

<!-- selector -->
  <rect class="hotspot" id="selector_knob" x="350" y="60" width="260" height="240"/>

  </svg>
  </div>
</div>

<!-- Status Display -->
<div class="status">
  <h3>Panel Status</h3>
  <div class="status-row">
    <span class="status-label">Selector:</span>
    <span class="status-value" id="statSelector">COM1</span>
  </div>
  <div class="status-row">
    <span class="status-label">Active RX:</span>
    <span class="status-value" id="statRx">None</span>
  </div>
  <div class="status-row">
    <span class="status-label">ADF:</span>
    <span class="status-value" id="statAdf">ON</span>
  </div>
  <div class="status-row">
    <span class="status-label">DPLR:</span>
    <span class="status-value" id="statDplr">ON</span>
  </div>
  <div class="status-row">
    <span class="status-label">PAT:</span>
    <span class="status-value" id="statPat">ON</span>
  </div>

  <div class="status-row">
    <span class="status-label">ISO/EMR:</span>
    <span class="status-value" id="statIso">OFF</span>
  </div>
  <div class="status-row">
    <span class="status-label">KEY:</span>
    <span class="status-value" id="statKey">OFF</span>
  </div>
</div>

<!-- Guide -->
<div class="guide">
  <h2>How to Operate</h2>
  <p><span class="key">RX Toggles (top row):</span> Click COM1, COM2, FM1, FM2, or AUX to toggle receive on/off</p>
  <p><span class="key">ISO/EMR (lower left):</span> Click to toggle isolation / emergency</p>
  <p><span class="key">KEY (lower right):</span> Click to toggle keying</p>
  <p><span class="key">Selector Knob (center):</span> Click and drag to snap between COM1 → FM → AUX → PA</p>
</div>

<script>
const toggleIds = ["com1_toggle","com2_toggle","fm1_toggle","fm2_toggle","aux_toggle","adf_toggle","dplr_toggle","pat_toggle","iso_emr","key_toggle"];
const photoSwitchIds = ["com1_toggle", "com2_toggle", "fm1_toggle", "fm2_toggle", "aux_toggle", "adf_toggle", "dplr_toggle", "pat_toggle", "iso_emr", "key_toggle"]; // switches with photo-real up/down visuals


const state = {};
// Initial panel state: base photo shows switches UP, so start them ON (UP)
const defaultState = {
  com1_toggle: true,
  com2_toggle: true,
  fm1_toggle: true,
  fm2_toggle: true,
  aux_toggle: true,
  adf_toggle: true,
  dplr_toggle: true,
  pat_toggle: true,
  iso_emr: false,
  key_toggle: true
};
let currentSelector = "COM1";

Object.assign(state, defaultState);
// Render initial toggle visuals
toggleIds.forEach(renderSwitch);
updateStatus();

function emit(d) {
  window.dispatchEvent(new CustomEvent("panel:change", { detail: d }));
}

function renderSwitch(id) {
  const p = document.getElementById(`patch_${id}`);
  if (!p) return;
  // Most patches represent the DOWN/OFF photo and only show when the toggle is OFF.
  // ISO/EMR is the opposite: its patch represents the UP/ON photo (base photo is DOWN/OFF there).
  const patchShowsWhenOn = (id === "iso_emr");
  const isOn = !!state[id];
  const show = patchShowsWhenOn ? isOn : !isOn;
  p.style.opacity = show ? "1" : "0";
  p.style.transform = show ? "translateY(0)" : "translateY(-3px)";
}

function flip(id) {
  const next = !state[id];
  state[id] = next;

  renderSwitch(id);
  emit({ type: "toggle", id, value: next });
  updateStatus();
}

/* Toggle hotspots — photo stays unchanged (no drawn overlays) */
toggleIds.forEach((id) => {
  const el = document.getElementById(id);
  if (!el) return;

  el.addEventListener("pointerup", (e) => {
    // Prevent "ghost" clicks on some mobile browsers
    e.preventDefault();
    e.stopPropagation();
    flip(id);
  }, { passive: false });
});

/* ===== SELECTOR DETENTS ===== */

const detents = [
  { name: "COM1", deg: -120 },
  { name: "FM",   deg: -40  },
  { name: "AUX",  deg:  40  },
  { name: "PA",   deg:  120 }
];

const cx = 470, cy = 215;

function angle(x, y) {
  return Math.atan2(y - cy, x - cx) * 180 / Math.PI;
}

function nearest(a) {
  let best = 0, d = 999;
  detents.forEach((s, i) => {
    const diff = Math.abs(a - s.deg);
    if (diff < d) { d = diff; best = i; }
  });
  return best;
}

document.getElementById("selector_knob").onpointermove = e => {
  if (e.buttons !== 1) return;
  const r = e.target.getBoundingClientRect();
  const x = (e.clientX - r.left) * (940 / r.width);
  const y = (e.clientY - r.top)  * (314 / r.height);

  const a = angle(x, y);
  const i = nearest(a);

  const rad = detents[i].deg * Math.PI / 180;
  const x2  = cx + Math.cos(rad) * 90;
  const y2  = cy + Math.sin(rad) * 90;

  const n = document.getElementById("needle");
  n.setAttribute("x2", x2);
  n.setAttribute("y2", y2);

  currentSelector = detents[i].name;
  emit({ type: "selector", step: detents[i].name });
  updateStatus();
};

/* ===== STATUS ===== */
function updateStatus() {
  document.getElementById("statSelector").textContent = currentSelector;

  const rxMap = {
    com1_toggle: "COM1",
    com2_toggle: "COM2",
    fm1_toggle:  "FM1",
    fm2_toggle:  "FM2",
    aux_toggle:  "AUX"
  };
  const activeRx = Object.entries(rxMap)
    .filter(([id]) => state[id])
    .map(([, label]) => label)
    .join(", ");
  document.getElementById("statRx").textContent  = activeRx  || "None";
  document.getElementById("statIso").textContent = state["iso_emr"]    ? "ON" : "OFF";
  document.getElementById("statAdf").textContent = state["adf_toggle"] ? "ON" : "OFF";
  document.getElementById("statDplr").textContent = state["dplr_toggle"] ? "ON" : "OFF";
  document.getElementById("statPat").textContent = state["pat_toggle"] ? "ON" : "OFF";
  document.getElementById("statKey").textContent = state["key_toggle"] ? "ON" : "OFF";
}

// Apply initial photo toggle visuals
toggleIds.forEach(renderSwitch);

updateStatus();

/* ===== SERVICE WORKER ===== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('SW registered:', reg.scope))
      .catch(err => console.log('SW registration failed:', err));
  });
}
</script>
</body>
</html>
